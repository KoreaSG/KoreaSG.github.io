<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¤‘ê³ ë§ˆì¼“ - ì‹±ê°€í¬ë¥´ í•œì¸ ì»¤ë®¤ë‹ˆí‹°</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="marketplace-body">
    <!-- í—¤ë” -->
    <header>
        <div class="header-content">
            <a href="index.html" class="logo">
                <div class="logo-icon">ğŸ¦</div>
                <span>SGí•œì¸ ì¤‘ê³ ë§ˆì¼“</span>
            </a>
        </div>
    </header>

    <!-- ë©”ì¸ ì½˜í…ì¸  -->
    <div class="main-container">
        <div class="page-header">
            <h1 class="page-title">ì¤‘ê³ ë§ˆì¼“</h1>
        </div>

        <!-- í•„í„° ì„¹ì…˜ -->
        <div class="filter-section">
            <div class="search-box">
                <input type="text" placeholder="ì°¾ìœ¼ì‹œëŠ” ë¬¼ê±´ì„ ê²€ìƒ‰í•´ë³´ì„¸ìš”" id="searchInput">
            </div>
            <select class="category-filter" id="categoryFilter">
                <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                <option value="electronics">ì „ìì œí’ˆ</option>
                <option value="furniture">ê°€êµ¬</option>
                <option value="clothing">ì˜ë¥˜</option>
                <option value="baby">ìœ ì•„ìš©í’ˆ</option>
                <option value="books">ë„ì„œ</option>
                <option value="etc">ê¸°íƒ€</option>
            </select>
        </div>

        <!-- ì œí’ˆ ê·¸ë¦¬ë“œ -->
        <div class="products-grid" id="productsGrid">
            <!-- ì œí’ˆì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            <div class="empty-state" id="emptyState">
                <div class="empty-icon">ğŸ“¦</div>
                <h3>ì•„ì§ ë“±ë¡ëœ ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤</h3>
                <p>ì²« ë²ˆì§¸ ì œí’ˆì„ ë“±ë¡í•´ë³´ì„¸ìš”!</p>
            </div>
        </div>
    </div>

    <!-- ì¶”ê°€ ë²„íŠ¼ -->
    <button class="add-button" onclick="openModal()">+</button>

    <!-- ì œí’ˆ ë“±ë¡ ëª¨ë‹¬ -->
    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ì œí’ˆ ë“±ë¡í•˜ê¸°</h2>
                <button class="close-button" onclick="closeModal()">&times;</button>
            </div>

            <form id="productForm">
                <div class="form-group">
                    <label class="form-label">ì œí’ˆ ì‚¬ì§„</label>
                    <div class="image-upload-area" id="imageUploadArea" onclick="document.getElementById('imageInput').click()">
                        <div class="upload-icon">ğŸ“·</div>
                        <p class="upload-text">í´ë¦­í•˜ì—¬ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
                    </div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)">
                </div>

                <div class="form-group">
                    <label class="form-label">ì œí’ˆëª…</label>
                    <input type="text" class="form-input" id="productTitle" required>
                </div>

                <div class="form-group">
                    <label class="form-label">ê°€ê²© (SGD)</label>
                    <input type="number" class="form-input" id="productPrice" placeholder="0" required>
                </div>

                <div class="form-group">
                    <label class="form-label">ì¹´í…Œê³ ë¦¬</label>
                    <select class="form-select" id="productCategory" required>
                        <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
                        <option value="electronics">ì „ìì œí’ˆ</option>
                        <option value="furniture">ê°€êµ¬</option>
                        <option value="clothing">ì˜ë¥˜</option>
                        <option value="baby">ìœ ì•„ìš©í’ˆ</option>
                        <option value="books">ë„ì„œ</option>
                        <option value="etc">ê¸°íƒ€</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">ìƒì„¸ ì„¤ëª…</label>
                    <textarea class="form-textarea" id="productDescription" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">ê±°ë˜ ì§€ì—­</label>
                    <input type="text" class="form-input" id="productLocation" placeholder="ì˜ˆ: Orchard, Tampines">
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button type="submit" class="btn btn-primary">ë“±ë¡í•˜ê¸°</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supabase JS CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<script>
    /** ================================
     *  Supabase ì´ˆê¸°í™” (ë³¸ì¸ í”„ë¡œì íŠ¸ ê°’ìœ¼ë¡œ êµì²´)
     *  ================================= */
    const SUPABASE_URL = 'https://thwnzvrhaenmcjjfmopn.supabase.co';      // â† ë³¸ì¸ í”„ë¡œì íŠ¸ URL
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRod256dnJoYWVubWNqamZtb3BuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQxOTY3ODYsImV4cCI6MjA2OTc3Mjc4Nn0.3pXQdSkLMk02xembZWfiROtIR6ETijinnIRA65WCY5Q';                  // â† ë³¸ì¸ anon public key
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /** ================================
     *  ìƒíƒœê°’: ì œí’ˆ ë°°ì—´ / ì—…ë¡œë“œ íŒŒì¼
     *  ================================= */
    let products = [];               // ì„œë²„ì—ì„œ ì½ì–´ì˜¨ ëª©ë¡ì„ ì—¬ê¸°ì— ë³´ê´€
    let uploadedImageFile = null;    // <input type="file">ì—ì„œ ë°›ì€ ì‹¤ì œ íŒŒì¼
    let uploadedImagePreview = null; // ë¯¸ë¦¬ë³´ê¸°ìš© dataURL (ì„ íƒ)

    /** ================================
     *  í˜ì´ì§€ ë¡œë“œ ì‹œ: ë°ì´í„° ë¶ˆëŸ¬ì™€ ë Œë”
     *  ================================= */
    document.addEventListener('DOMContentLoaded', async function() {
    await loadProducts();
    renderProducts();
    });

    /** ================================
     *  ì œí’ˆ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (Supabase SELECT)
     *  ================================= */
    async function loadProducts() {
    const { data, error } = await supabaseClient
        .from('products')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Failed to load products:', error);
        showNotification('ì œí’ˆ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆì–´ìš”.');
        return;
    }
    products = data || [];
    }

    /** ================================
     *  ë Œë”ë§ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
     *  ================================= */
    function renderProducts() {
    const grid = document.getElementById('productsGrid');
    const emptyState = document.getElementById('emptyState');

    if (!products || products.length === 0) {
        grid.innerHTML = emptyState.outerHTML;
        return;
    }

    grid.innerHTML = products.map((product, index) => `
        <div class="product-card" onclick="viewProduct(${index})">
        <img src="${product.image_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="200" viewBox="0 0 400 200"><rect fill="%23f0f0f0" width="400" height="200"/><text x="50%" y="50%" text-anchor="middle" fill="%23999" font-size="20">No Image</text></svg>'}" 
            alt="${escapeHtml(product.title)}" class="product-image">
        <div class="product-info">
            <h3 class="product-title">${escapeHtml(product.title)}</h3>
            <p class="product-price">S$${product.price}</p>
            <div class="product-meta">
            <span>ğŸ“ ${escapeHtml(product.location || 'ìœ„ì¹˜ ë¯¸ì •')}</span>
            <span>${formatDate(new Date(product.created_at))}</span>
            </div>
        </div>
        </div>
    `).join('');
    }

    /** ================================
     *  ëª¨ë‹¬ ì—´ê³  ë‹«ê¸° / í¼ ë¦¬ì…‹ (ê¸°ì¡´)
     *  ================================= */
    function openModal() {
    document.getElementById('productModal').style.display = 'block';
    document.body.style.overflow = 'hidden';
    }
    function closeModal() {
    document.getElementById('productModal').style.display = 'none';
    document.body.style.overflow = 'auto';
    resetForm();
    }
    function resetForm() {
    document.getElementById('productForm').reset();
    uploadedImageFile = null;
    uploadedImagePreview = null;
    const uploadArea = document.getElementById('imageUploadArea');
    uploadArea.classList.remove('has-image');
    uploadArea.innerHTML = `
        <div class="upload-icon">ğŸ“·</div>
        <p class="upload-text">í´ë¦­í•˜ì—¬ ì‚¬ì§„ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</p>
    `;
    }

    /** ================================
     *  ì´ë¯¸ì§€ ì—…ë¡œë“œ (ë¯¸ë¦¬ë³´ê¸° + íŒŒì¼ ë³´ê´€)
     *  ================================= */
    function handleImageUpload(event) {
    const file = event.target.files[0];
    if (file && file.type.startsWith('image/')) {
        uploadedImageFile = file;

        // ë¯¸ë¦¬ë³´ê¸°
        const reader = new FileReader();
        reader.onload = function(e) {
        uploadedImagePreview = e.target.result;
        const uploadArea = document.getElementById('imageUploadArea');
        uploadArea.classList.add('has-image');
        uploadArea.innerHTML = `<img src="${uploadedImagePreview}" class="uploaded-image" alt="Uploaded">`;
        };
        reader.readAsDataURL(file);
    }
    }

    /** ================================
     *  í¼ ì œì¶œ: Storage ì—…ë¡œë“œ â†’ DB INSERT
     *  ================================= */
    document.getElementById('productForm').addEventListener('submit', async function(e) {
    e.preventDefault();

    // 1) ì…ë ¥ê°’ ìˆ˜ì§‘
    const title = document.getElementById('productTitle').value.trim();
    const price = parseFloat(document.getElementById('productPrice').value);
    const category = document.getElementById('productCategory').value;
    const description = document.getElementById('productDescription').value.trim();
    const location = document.getElementById('productLocation').value.trim();

    // ê°„ë‹¨ ê²€ì¦
    if (!title || isNaN(price)) {
        showNotification('ì œëª©ê³¼ ê°€ê²©ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.');
        return;
    }

    // 2) ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ Storageì— ì—…ë¡œë“œí•˜ê³  ê³µê°œ URL í™•ë³´
    let imageUrl = null;
    if (uploadedImageFile) {
        const path = `products/${Date.now()}_${sanitizeFileName(uploadedImageFile.name)}`;
        const { data: uploadData, error: uploadError } = await supabaseClient
        .storage.from('product-images')
        .upload(path, uploadedImageFile, {
            cacheControl: '3600',
            upsert: false
        });

        if (uploadError) {
        console.error('Upload failed:', uploadError);
        showNotification('ì´ë¯¸ì§€ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        return;
        }

        // ê³µê°œ URL ë§Œë“¤ê¸°
        const { data: publicData } = supabaseClient
        .storage.from('product-images')
        .getPublicUrl(uploadData.path);

        imageUrl = publicData?.publicUrl || null;
    }

    // 3) DBì— ì œí’ˆ INSERT
    const { data, error } = await supabaseClient
        .from('products')
        .insert([{
        title,
        price,
        category,
        description,
        location,
        image_url: imageUrl
        // created_atì€ default now()
        }])
        .select(); // ë°©ê¸ˆ ì¶”ê°€í•œ í–‰ ë°˜í™˜

    if (error) {
        console.error('Insert failed:', error);
        showNotification('ì œí’ˆ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        return;
    }

    // 4) ë¡œì»¬ ìƒíƒœ ê°±ì‹  â†’ ë Œë”
    if (data && data.length > 0) {
        products.unshift(data[0]); // ìµœì‹ ì´ ìœ„ë¡œ ì˜¤ë„ë¡
    } else {
        // ë˜ëŠ” ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ ë¶ˆëŸ¬ì˜¤ëŠ” ë°©ë²•
        await loadProducts();
    }

    renderProducts();
    closeModal();
    showNotification('ì œí’ˆì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
    });

    /** ================================
     *  ìƒì„¸ ë³´ê¸° (ê¸°ì¡´ ë¡œì§ ìœ ì§€, í•„ë“œëª…ë§Œ ë§ì¶¤)
     *  ================================= */
    function viewProduct(index) {
    const product = products[index];
    alert(
        `ì œí’ˆëª…: ${product.title}\n` +
        `ê°€ê²©: S$${product.price}\n` +
        `ì„¤ëª…: ${product.description || ''}\n` +
        `ìœ„ì¹˜: ${product.location || 'ìœ„ì¹˜ ë¯¸ì •'}`
    );
    }

    /** ================================
     *  ê²€ìƒ‰/í•„í„° (ê¸°ì¡´ ë¡œì§ ìœ ì§€, image_url/created_at ì‚¬ìš©)
     *  ================================= */
    document.getElementById('searchInput').addEventListener('input', function() {
    filterProducts();
    });
    document.getElementById('categoryFilter').addEventListener('change', function() {
    filterProducts();
    });

    function filterProducts() {
    const searchTerm = (document.getElementById('searchInput').value || '').toLowerCase();
    const category = document.getElementById('categoryFilter').value;

    const filtered = (products || []).filter(product => {
        const title = (product.title || '').toLowerCase();
        const desc = (product.description || '').toLowerCase();
        const matchesSearch = title.includes(searchTerm) || desc.includes(searchTerm);
        const matchesCategory = !category || product.category === category;
        return matchesSearch && matchesCategory;
    });

    const grid = document.getElementById('productsGrid');
    if (filtered.length === 0) {
        grid.innerHTML = `
        <div class="empty-state">
            <div class="empty-icon">ğŸ”</div>
            <h3>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</h3>
            <p>ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¥¼ ì‹œë„í•´ë³´ì„¸ìš”</p>
        </div>
        `;
    } else {
        grid.innerHTML = filtered.map((product, index) => {
        // í˜„ì¬ ë°°ì—´ì—ì„œ index ë§¤í•‘
        const originalIndex = products.indexOf(product);
        return `
            <div class="product-card" onclick="viewProduct(${originalIndex})">
            <img src="${product.image_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="200" viewBox="0 0 400 200"><rect fill="%23f0f0f0" width="400" height="200"/><text x="50%" y="50%" text-anchor="middle" fill="%23999" font-size="20">No Image</text></svg>'}" 
                alt="${escapeHtml(product.title)}" class="product-image">
            <div class="product-info">
                <h3 class="product-title">${escapeHtml(product.title)}</h3>
                <p class="product-price">S$${product.price}</p>
                <div class="product-meta">
                <span>ğŸ“ ${escapeHtml(product.location || 'ìœ„ì¹˜ ë¯¸ì •')}</span>
                <span>${formatDate(new Date(product.created_at))}</span>
                </div>
            </div>
            </div>
        `;
        }).join('');
    }
    }

    /** ================================
     *  ìœ í‹¸: ë‚ ì§œ / ì•Œë¦¼ / ì•ˆì „ ì²˜ë¦¬
     *  ================================= */
    function formatDate(date) {
    const now = new Date();
    const diff = now - date;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    if (minutes < 1) return 'ë°©ê¸ˆ ì „';
    if (minutes < 60) return `${minutes}ë¶„ ì „`;
    if (hours < 24) return `${hours}ì‹œê°„ ì „`;
    if (days < 7) return `${days}ì¼ ì „`;
    return date.toLocaleDateString('ko-KR');
    }

    function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed; top: 20px; right: 20px;
        background: var(--success-color, #16a34a);
        color: white; padding: 1rem 2rem; border-radius: 10px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1002;
        animation: slideIn 0.3s ease;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° (ê¸°ì¡´)
    window.onclick = function(event) {
    const modal = document.getElementById('productModal');
    if (event.target == modal) closeModal();
    }

    // HTML ì´ìŠ¤ì¼€ì´í”„(ê°„ë‹¨ XSS ë°©ì§€)
    function escapeHtml(str) {
    return String(str || '')
        .replace(/&/g, '&amp;').replace(/</g, '&lt;')
        .replace(/>/g, '&gt;').replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    // íŒŒì¼ëª… ì•ˆì „í™”
    function sanitizeFileName(name) {
    return name.replace(/[^\w.\-]+/g, '_');
    }
</script>

</body>
</html>